# 2. JVM

Created: 2020년 8월 12일

JVM은 스택기반의 해석 머신이다. 레지스터는 없지만 일부 결과를 **실행 스택** 에 보관하며 이 스택의 값들을 가져와 계산한다.

## JVM 인터프리터

JVM 인터프리터의 기본로직은, 평가스택(evaluate stack) 을 이용해 중간값을 담아두고 가장 마지막에 실행된 명령어와 opcode 를 하나씩 순서대로 처리하는 while 루프안의 switch 문 이다.

java HelloWorld 명령을 내리면 일어나는 일

- OS는 가상머신 프로세스(자바 바이너리)를 구동한다
- 이 과정에서 자바 클래스로딩이 일어난다
- 자바 클래스 로더는 부트스트랩 클래스(Object, ClassLoader 만 로드)>자바 런타임 코어 클래스 > 확장 클래스 순으로 로드 한다
- 가상환경이 구성되고 스택머신이 초기화된다
- HelloWorld 클래스 파일이 실행된다

application entry point는 main()메소드이므로 제어권을 이 클래스로 넘기려면 **가상 머신이 실행되기 전에 이 클래스를 로드해야한다**

자바는 프로그램 실행중 처음 보는 새 클래스를 dependency에 로드한다. 클래스를 찾지못한 클래스로더는 부모클래스에게 룩업을 넘긴다. 이렇게 부트스트랩까지 찾지못하면 `ClassNotFoundException` 이 발생한다. 

## 바이트 코드 실행

- javac 로 자바 파일을 class 파일로 컴파일 하면 그 결과로 바이트 코드가 생성된다.
- 최적화는 거의 하지 않기 때문에 자바 SDK 내의 javap라는 역 어셈블러로 쉽게 해독 가능함
- 자바파일 → javac → .class(바이트코드) 파일
- 바이트 코드는 플랫폼 종속적이지 않은 IR(Intermediate Representation)이다.
- 모든 클래스 파일은 `0xCAFEBABE` 라는 매직넘버, 4바이트 16진수로 시작한다. 그 다음의 4바이트는 클래스 파일 컴파일에 필요한 메이저/마이너 버전 숫자이다(런타임 버전이 컴파일된 클래스 파일 버전보다 낮으면 안되기 때문에 버전 체크를 위함)
- **상수 풀** 에는 코드곳곳의 상숫값이 있다. JVM은 코드를 실행할 때 런타임에 배치된 메모리 대신 이 상수 풀 테이블을 찾아보고 값을 참조한다.
- **엑세스 플래그** 는 클래스에 적용할 수정자를 결정한다.
    - 첫부분은 일반 프로퍼티로 public인지 final인지, 인터페이스인지 추상클래스인지 표시한다.
    - 끝 부분은 합성클래스인지 annotation 타입인지 enum인지 나타낸다.
- this class, super class, interface 는 클래스에 포함된 타입계층을 나타내며 상수풀을 가리키는 **인덱스**로 표시한다.
- 필드와 메소드는 시그니처 비슷한 구조를 정의하고 modifier 도 포함되어있다.
    - 예를들어 메소드는 code 속성으로 특정 메소드와 연관된 바이트 코드를 나타낸다.

```
클래스 파일 구조 암기요령
My     Very   Cute     Animal Turns Savage   In      Full   Moon   Area
magin version constant access this  super  interface field methods attributes
```

## JIT(Just In Time) 컴파일

핫스팟VM이 인터프리티드 모드로 실행되는 동안 애플리케이션을 모니터링하며 자주 실행되는 코드 파트를 발견해 메소드와 루프를 인터프리티드 바이트 코드에서 **네이티브 코드**로 컴파일 하는 것을 JTI라 한다.

특정 메소드가 threshold(임계점)을 넘어가면 프로파일러가 해당 코드를 컴파일/최적화 한다.

자바처럼 프로필 기반 최적화(PGO)를 응용하는 환경에선 AOT 플랫폼에서 불가능한 방식으로 런타임 정보를 활용할 여지가 있으므로 **동작 인라이닝** 또는 **virtual call** 등으로 성능을 개선할 수 있다. 

- AOT(Ahead Of Time) 이란?
    - 특정 플랫폼에서만 사용 가능한 기계어로 컴파일
    - 컴파일은 중간 언어 형태로 배포된 후 목표 시스템에서 인터프리터나 JIT 컴파일 등 기계어 번역을 통해 실행되는 중간언어를 목표시스템에 맞는 기계어로 번역하는 방식

## JVM 메모리 관리