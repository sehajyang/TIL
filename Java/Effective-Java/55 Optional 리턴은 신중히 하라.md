# 55. Optional 리턴은 신중히 하라

Created: 2021년 5월 23일
Created by: Seha Jyang

optional 등장 이전엔 값을 리턴할 수 없을때 취할 수 있는 방법은 예외를 던지거나 null을 리턴하는 것이었는데, 예외는 진짜 예외적인 상황에서만 사용해야하며 예외를 생성할 때 스택 추적 전체를 캡쳐하므로 비용도 만만치않다. 그렇다고 null을 리턴하면 호출한 쪽에서 null 처리 코드를 작성해줘야 한다.

Optional<T>는 null이 아닌 T타입 참조를 하나 담고있거나 아무것도 담지 않을 수 있다. 옵셔널은 원소를 최대 1개 가질 수 있는 불변 컬렉션이다.

T를 리턴해야 하지만 특저 ㅇ조건에선 아무것도 리턴하지 않아야 할 때 T대신 Optional<T>를 리턴하도록 선언하면 된다. 이렇게 하면 예외를 던지는 메서드보다 유연하고 사용하기 쉬우며 null을 리턴하는 메서드보다 오류 가능성이 작다.

**Optional을 리턴하는 메서드에서는 절대 null을 리턴하지 말자**

**Optional은 검사 예외와 취지가 비슷하다** 즉 리턴 값이 없을수도 있음을 API유저에게 명확히 알려주기 위함이다.

Optional에 항상 값이 채워져 있다고 확신하면 Optional.get() 을 사용하면 된다. 하지만 채워져 있지 않으면 예외가 발생할 것이다.

기본값을 설정하는 비용이 커서 부담이 될 땐 `orElseGet` 을 사용하자, 값이 필요할 때 Supplier<T>를 사용해 생성하므로 초기 설정 비용을 낮출 수 있다.

스트림을 사용한다면 옵셔널을 Stream<Optional<T>>로 받아서 채워진 옵셔널들에 값을 뽑아 Stream<T>에 건네담아 처리할 수 있다.

```java
streamOfOptionals
  .filter(Optional::isPresent)
  .map(Optional::get)
```

다음과 같이 명료하게 바꿀 수도 있다.

```java
streamOfOptionals.flatMap(Optional::stream)
```

리턴값으로 옵셔널을 사용한다고 해서 무조건 좋은것이 아니다. **컬렉션, 스트림, 배열, 옵셔널 같은 컨테이너 타입은 옵셔널로 감싸면 안 된다.**

**결과가 없을 수 있으며, 클라이언트가 이 상황을 특별하게 처리해야 한다면 Optional<T>를 리턴한다**

Optional도 새로 할당하고 초기화 해야 하는 객체이고 그 안에서 값을 꺼내려면 메서드를 호출해야 하니 성능이 중요한 상황에선 옵셔널이 맞지 않을 수 있다.

int, long, double은 OptionalInt, OptionalLong, OptionalDouble을 쓰고 **박싱된 기본 타입을 담은 옵셔널을 리턴하는 일은 없도록 하자**

**옵셔널을 맵의 값으로 사용하면 절대 안된다.** 만약 그렇게 한다면 맵 안에 키가 없다는 사실을 나타내는 방법이 두 가지가 된다.

**옵셔널을 컬렉션의 키, 값, 원소나 배열의 원소로 사용하는게 적절한 상황은 거의 없다.**

## 정리

값을 리턴하지 못할 가능성이 있고, 호출할때마다 리턴값이 없을 가능성을 염두에 둬야 하는 메서드라면 옵셔널을 리턴해야 할 상황일 수 있다. 하지만 옵셔널 리턴에는 성능 저하가 뒤따르니 성능에 민감한 메서드라면 null을 리턴하거나 예외를 던지는 편이 나을 수 있다. 그리고 옵셔널을 리턴값 이외의 용도로 쓰는 경우는 매우 드물다.